name: Trigger auto deployment for cxo-test

on:
  push:
    branches:
      - master
    paths:
      - '**'
      - '.github/workflows/cxo-test-AutoDeployTrigger.yml'

  workflow_dispatch:

env:
  VERSION: v0.0.0

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # Step 0: Checkout the repository
      - name: Checkout to the branch
        uses: actions/checkout@v4

      # Step 1: Generate a dynamic version tag
      - name: Generate Version Tag
        id: version
        run: echo "VERSION=v$(date +'%Y.%m.%d.%H%M')" >> $GITHUB_ENV

      # Step 2: Azure Login
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.CXOTEST_AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.CXOTEST_AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.CXOTEST_AZURE_SUBSCRIPTION_ID }}

      # Step 3: Build and push Docker image to Azure Container Registry
      - name: Build and push container image to Azure Container Registry
        run: |
          # Define registry and image name
          REGISTRY=${{ secrets.CXOTEST_REGISTRY_URL }}
          if [ -z "$REGISTRY" ]; then
            echo "âŒ ERROR: CXOTEST_REGISTRY_URL secret is not set."
            exit 1
          fi

          IMAGE_NAME=$REGISTRY/cxo-test:${{ env.VERSION }}

          echo "ðŸ”§ Using registry: $REGISTRY"
          echo "ðŸš€ Building image: $IMAGE_NAME"

          # Build and push
          echo "${{ secrets.CXOTEST_REGISTRY_PASSWORD }}" | docker login $REGISTRY --username ${{ secrets.CXOTEST_REGISTRY_USERNAME }} --password-stdin
          docker build -t $IMAGE_NAME .
          docker push $IMAGE_NAME

          # Store IMAGE_NAME for later steps
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      # Step 4: Deploy the container app to Azure
      - name: Deploy to Azure Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          appSourcePath: ${{ github.workspace }}
          dockerfilePath: ./Dockerfile
          registryUrl: ${{ secrets.CXOTEST_REGISTRY_URL }}
          registryUsername: ${{ secrets.CXOTEST_REGISTRY_USERNAME }}
          registryPassword: ${{ secrets.CXOTEST_REGISTRY_PASSWORD }}
          containerAppName: cxo-test
          resourceGroup: cxo
          imageToBuild: ${{ env.IMAGE_NAME }}
          tags: |
            Version=${{ env.VERSION }}
            BuildCommit=${{ github.sha }}
          envVars: |
            APP_VERSION=${{ env.VERSION }}

      # Step 5: Record deployed version info
      - name: Record deployed version
        run: |
          echo "Deployed version: ${{ env.VERSION }}" >> version-history.log
          echo "Commit: ${{ github.sha }}" >> version-history.log
          echo "Date: $(date)" >> version-history.log
          echo "---" >> version-history.log
